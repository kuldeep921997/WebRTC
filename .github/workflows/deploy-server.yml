name: Deploy Server

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

jobs:
  # Deploy to Render
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    # Only run if secrets are configured
    if: ${{ secrets.RENDER_DEPLOY_HOOK != '' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            echo "‚ùå Error: RENDER_DEPLOY_HOOK secret is not configured"
            echo "üëâ Follow NEXT_STEPS.md to set up deployment"
            echo "üëâ Or disable this workflow by setting if: false"
            exit 1
          fi
          echo "‚úÖ Secrets configured"
      
      - name: Deploy to Render
        run: |
          echo "üì§ Triggering Render deployment..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
          if [ $? -eq 0 ]; then
            echo "‚úÖ Deployment hook triggered successfully"
          else
            echo "‚ùå Deployment hook failed"
            exit 1
          fi
      
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30
      
      - name: Verify deployment
        run: |
          echo "‚úÖ Server deployment triggered!"
          echo "Check status at: https://dashboard.render.com"

  # Alternative: Deploy to Railway
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    if: false  # Set to true to enable Railway deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        run: railway up --service=webrtc-server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Server deployed to Railway!"

  # Alternative: Deploy to Heroku
  deploy-heroku:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    if: false  # Set to true to enable Heroku deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.12.14
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "server"
          procfile: "web: node index.js"
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health
          echo "‚úÖ Server deployed to Heroku!"

  # Alternative: Deploy to DigitalOcean App Platform
  deploy-digitalocean:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    if: false  # Set to true to enable DigitalOcean deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Deploy to App Platform
        run: |
          doctl apps create-deployment ${{ secrets.DIGITALOCEAN_APP_ID }}
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Server deployed to DigitalOcean!"

  # Health Check after deployment
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-render]
    # Only run if deploy-render succeeded
    if: ${{ success() && secrets.SERVER_URL != '' }}
    
    steps:
      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.SERVER_URL }}" ]; then
            echo "‚ö†Ô∏è Warning: SERVER_URL secret is not configured"
            echo "Skipping health check"
            exit 0
          fi
      
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for Render to complete deployment (30 seconds)..."
          sleep 30
      
      - name: Check server health
        run: |
          HEALTH_URL="${{ secrets.SERVER_URL }}/health"
          echo "üîç Checking: $HEALTH_URL"
          
          for i in {1..5}; do
            if curl -f "$HEALTH_URL"; then
              echo "‚úÖ Server is healthy!"
              exit 0
            fi
            echo "‚è≥ Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          echo "Check Render logs: https://dashboard.render.com"
          exit 1
      
      - name: Notify deployment status
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Server URL: ${{ secrets.SERVER_URL }}"
