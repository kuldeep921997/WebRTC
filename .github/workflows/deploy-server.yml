name: Deploy Server

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

jobs:
  # Deploy to Render
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Render
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
      
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30
      
      - name: Verify deployment
        run: |
          echo "‚úÖ Server deployment triggered!"
          echo "Check status at: https://dashboard.render.com"

  # Alternative: Deploy to Railway
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    if: false  # Set to true to enable Railway deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        run: railway up --service=webrtc-server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Server deployed to Railway!"

  # Alternative: Deploy to Heroku
  deploy-heroku:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    if: false  # Set to true to enable Heroku deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.12.14
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "server"
          procfile: "web: node index.js"
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health
          echo "‚úÖ Server deployed to Heroku!"

  # Alternative: Deploy to DigitalOcean App Platform
  deploy-digitalocean:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    if: false  # Set to true to enable DigitalOcean deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Deploy to App Platform
        run: |
          doctl apps create-deployment ${{ secrets.DIGITALOCEAN_APP_ID }}
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Server deployed to DigitalOcean!"

  # Health Check after deployment
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-render]
    
    steps:
      - name: Wait for deployment
        run: sleep 30
      
      - name: Check server health
        run: |
          HEALTH_URL="${{ secrets.SERVER_URL }}/health"
          echo "Checking: $HEALTH_URL"
          
          for i in {1..5}; do
            if curl -f $HEALTH_URL; then
              echo "‚úÖ Server is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          
          echo "‚ùå Health check failed"
          exit 1
      
      - name: Notify deployment status
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Server URL: ${{ secrets.SERVER_URL }}"
