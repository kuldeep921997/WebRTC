name: CI - Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Test Server
  test-server:
    name: Test Server
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./server
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for syntax errors
        run: node -c index.js
      
      - name: Run signaling test (background)
        run: |
          # Start server in background
          node index.js &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 3
          
          # Check if server is running
          curl -f http://localhost:5000/health || exit 1
          
          # Kill server
          kill $SERVER_PID
      
      - name: Check server health endpoint
        run: |
          node index.js &
          SERVER_PID=$!
          sleep 2
          curl -f http://localhost:5000/health
          curl -f http://localhost:5000/rooms
          kill $SERVER_PID

  # Test Client
  test-client:
    name: Test Client
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./client
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build client
        run: npm run build
        env:
          VITE_SIGNALING_SERVER: ${{ secrets.SIGNALING_SERVER_URL || 'http://localhost:5000' }}
      
      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          echo "Build successful!"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: client-build
          path: client/dist
          retention-days: 7

  # Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    # Run after tests pass
    needs: [test-server, test-client]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Check file structure
        run: |
          echo "Checking project structure..."
          test -f server/index.js || exit 1
          test -f client/src/App.jsx || exit 1
          test -f package.json || exit 1
          echo "âœ… Project structure is valid"
      
      - name: Check for TODO/FIXME
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" server/ client/src/ || echo "No TODOs found"
      
      - name: Check package.json validity
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json'))"
          node -e "JSON.parse(require('fs').readFileSync('server/package.json'))"
          node -e "JSON.parse(require('fs').readFileSync('client/package.json'))"
          echo "âœ… All package.json files are valid"

  # Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    # Run in parallel with code-quality
    needs: [test-server, test-client]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Audit server dependencies
        run: |
          cd server
          npm audit --audit-level=moderate || true
      
      - name: Audit client dependencies
        run: |
          cd client
          npm audit --audit-level=moderate || true

  # Integration Test (Optional)
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [test-server, test-client]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install all dependencies
        run: |
          cd server && npm ci && cd ..
          cd client && npm ci && cd ..
      
      - name: Start server and test
        run: |
          cd server
          node index.js &
          SERVER_PID=$!
          sleep 3
          
          # Test signaling
          node test-signaling.js &
          TEST_PID=$!
          
          # Wait for test to complete (5 seconds as per script)
          sleep 6
          
          # Cleanup
          kill $SERVER_PID || true
          
          echo "âœ… Integration test passed"

  # Build Status Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test-server, test-client, code-quality, security-audit]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "ðŸŽ‰ CI Pipeline completed!"
          echo "Server tests: ${{ needs.test-server.result }}"
          echo "Client tests: ${{ needs.test-client.result }}"
          echo "Code quality: ${{ needs.code-quality.result }}"
          echo "Security audit: ${{ needs.security-audit.result }}"
